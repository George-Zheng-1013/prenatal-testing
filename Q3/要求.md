# 一、目标与产出

* **目标** ：在综合 BMI、年龄、身高、体重、IVF 与测序质量等因素、并考虑检测误差与“达标比例”（Y≥4%）的条件下，为**各 BMI 组**给出 **最佳检测时点** ，使“潜在风险”最小（更早发现、足够达标、避免晚期）。
* **产出** ：

1. **BMI 分组区间表** （3–5 组为宜，含切点与样本量）；
2. **每组单次检测的最佳孕周** （备选：12±、13–27 内推荐周）；
3. **每组两阶段策略** ：早测周 t0gt_0^g**t**0**g** 与复测周 t1gt_1^g**t**1**g**；
4. 验证指标：达标比例、预期完成时间/风险、首采失败率、敏感性分析图表；
5. 附：代码与可复现脚本、图表、说明文档（含 AI 工具使用记录以满足竞赛要求）。

# 二、数据处理（Data → 可建模数据集）

 **数据范围与记录级别** ：以“ **一次检测（采血）** ”为一条记录；同一孕妇可多次检测（用于两阶段与区间删失）。

1. **清洗与一致化**

* 去除明显错误/重复；统一时间到 **孕周（小数周）** ；统一计量单位。
* 仅保留**男胎**记录（Y 浓度/ Y Z 值非空者）。
* 质量筛查（稳健型）：
  * 极端低读段/极端高重复率剔除或降权；
  * 可选：按实验室建议或经验阈值过滤**明显失配**样本；
  * 备注：GC 偏倚等会影响定量精度（作为**质量协变量**在模型里校正，而非“一刀切”删除）。
* 关键派生字段
  * **达标标签** ：hit=1\mathrm{hit}=1**hit**=**1** 若 Y_conc≥4%Y\_\mathrm{conc}\ge 4\%**Y**_**conc**≥**4%**，否则 0；
  * **个体级 ID** 、 **序号化检测时间** ；
  * **孕周区间** ：早（≤12）、中（13–27）、晚（≥28）用于风险函数。
  * **质量协变量** ：原始读段数、比对比例、重复率、唯一比对数、各染色体 GC、过滤比例等（用于误差建模/加权）。

2. **多次检测 → 事件时间结构（区间删失）**

* 定义“ **最早达标时间** ”T\*T^\***T**\*：孕妇首次达到 Y≥4%Y\ge 4\%**Y**≥**4%** 的孕周。
* 由多次检测构造区间删失：
  * 若第 1 次就达标：**左删失** T\*≤t1T^\*\le t_1**T**\***≤**t**1**；
  * 若有“最后一次未达标 tLt_L**t**L”与“第一次达标 tRt_R**t**R”：**区间删失** tL<T\*≤tRt_L < T^\* \le t_R**t**L<**T**\***≤**t**R**；
  * 若至最后一次仍未达标：**右删失** T\*>tlastT^\* > t_\mathrm{last}**T**\***>**t**last**。
* 记录每位孕妇的 [Li,Ri][L_i, R_i]**[**L**i****,**R**i]** 区间与协变量 XiX_i**X**i（BMI、体重、身高、年龄、IVF、质量等）。

# 三、建模（多因素、误差、达标比例）

## **离散时间危险度（person-period）模型** —— 逐周达标概率

* 将 10–25 周离散为周网格（或半周），对每位孕妇生成 person-period 展开表，目标为**本周首次达标**的危险度：

  Pr⁡(T\*=t∣T\*≥t,X)=logit−1{α(t)+β⊤X}\Pr(T^\*=t \mid T^\*\ge t, X) = \mathrm{logit}^{-1}\{\alpha(t)+\beta^\top X\}**Pr**(**T**\***=**t**∣**T**\***≥**t**,**X**)**=**logit**−**1**{**α**(**t**)**+**β**⊤**X**}
* **输出** ：得到 Fg(t)F_g(t)**F**g(**t**) 的逐周估计与置信带；直观、易与“达标比例”联动。
* **优点** ：实现简单、诊断直观，便于加“ **单调性** ”（孕周越大，达标危险度不降）。

> 二者都会产出 Fg(t)F_g(t)**F**g(**t**)（“到 t 周为止的达标比例”）。这正好呼应问题三中“达标比例”的要求，用来选最佳时点与两阶段策略。

### 检测误差/质量的处理

* **误差校正** ：将质量协变量进入模型（或作为 **测量权重** ）以降低“低质量样本把达标时间推迟”的偏差。
* **no-call 的处理** ：可建“可判定概率”子模型（质量→能否判定），对主模型做**逆概率加权**或 **联合建模** （简化可先做敏感性分析：包含/不包含 no-call 的对比）。

### 拟合与验证

* K 折交叉验证（按孕妇分层抽样），评估：
  * **校准** ：预测 Fg(t)F_g(t)**F**g(**t**) vs. 观察 Kaplan–Meier/Turnbull 分布（组别维度）；
  * **判别** ：组间 Fg(t)F_g(t)**F**g(**t**) 曲线分离度；
  * **稳健性** ：删去边缘质量样本、不同删失构型的稳定性。

# 四、按 BMI 分组（多因素入模，最终产出为 BMI 区间）

 **原则** ：建模阶段充分利用多因素，但最终只给出  **BMI 切点** 。推荐两种可解释做法：

**监督式最优分箱（带单调约束）**

* **自变量** ：BMI； **目标** ：基于拟合得到的“ **达标时间 T\*T^\***T**\*** ”或“ **在 t* 周是否达标** ”的监督信号，优化切点；
* 约束： **单调性** （BMI↑→达标更晚/比例更低）、 **每组最小样本数** 、 **每组最小达标数** ；
* 组数选择：3–5 组，按 BIC/交叉验证风险挑选。

> 产出： **BMI 区间表** （如：(−∞,28],(28,32],(32,36],(36,+∞)(-\infty,28], (28,32], (32,36], (36,+\infty)**(**−**∞**,**28**]**,**(**28**,**32**]**,**(**32**,**36**]**,**(**36**,**+**∞**)**），附每组样本量与基本特征。

# 五、选“最佳 NIPT 时点”：两阶段

## 两阶段（推荐，用于问题三强化版）

* **策略** ：首测 t0gt_0^g**t**0**g**，若未达标/不可判定，则在 t1gt_1^g**t**1**g** 复测。
* **期望成本/时间** （可二选一为目标）：
* **预期完成时间** ：

  ETg(t0,t1)=t0 Fg(t0)+t1 [Fg(t1)−Fg(t0)]+τ [1−Fg(t1)]\mathrm{ET}_g(t_0,t_1) = t_0\,F_g(t_0) + t_1\,[F_g(t_1)-F_g(t_0)] + \tau\, [1-F_g(t_1)]**ET**g(**t**0,**t**1)**=**t**0****F**g****(**t**0****)**+**t**1****[**F**g****(**t**1****)**−**F**g****(**t**0****)]**+**τ**[**1**−**F**g****(**t**1****)]**
  其中 τ\tau**τ** 可取 25–26 周上限或附加惩罚；
* **预期风险/成本** ：

  Rg(t0,t1)=λ [1−Fg(t1)]+c131(t0≥13)+c281(t0≥28)+κ (质量/复测成本)\mathrm{R}_g(t_0,t_1) = \lambda\,[1-F_g(t_1)] + c_{13}\mathbf{1}(t_0\ge 13) + c_{28}\mathbf{1}(t_0\ge 28)

  + \kappa\,\text{(质量/复测成本)}**R**g(**t**0,**t**1)**=**λ**[**1**−**F**g****(**t**1****)]**+**c**13****1**(**t**0****≥**13**)**+**c**28****1**(**t**0****≥**28**)**+**κ**(**质量**/**复测成本**)
* **约束** ：Fg(t1)≥πmin⁡F_g(t_1)\ge \pi_{\min}**F**g(**t**1)**≥**π**m**i**n**（总体覆盖），并可对首测成功率 Fg(t0)F_g(t_0)**F**g(**t**0) 设下限（减少复测负担）。
* **求解** ：在网格 t0∈[10,20]t_0\in[10,20]**t**0∈**[**10**,**20**]**、t1∈[t0+1,25]t_1\in[t_0+1,25]**t**1∈**[**t**0****+**1**,**25**]** 上**穷举/网格搜索**或 **贝叶斯优化** ，取 ET\mathrm{ET}**ET** 或 R\mathrm{R}**R** 最小的点对 (t0g,t1g)(t_0^g,t_1^g)**(**t**0**g,**t**1**g****)**。

> 输出：每个 BMI 组的 (t0g,t1g)(t_0^g,t_1^g)**(**t**0**g,**t**1**g****)**、Fg(t0g),Fg(t1g)F_g(t_0^g),F_g(t_1^g)**F**g****(**t**0**g****)**,**F**g****(**t**1**g****)**、预期完成时间/风险、需要复测的比例等。

# 六、统计推断与稳健性

* **区间估计** ：对 Fg(t)F_g(t)**F**g(**t**)、tgt_g**t**g、(t0g,t1g)(t_0^g,t_1^g)**(**t**0**g,**t**1**g****)** 做  **bootstrap** （按孕妇重抽），给出 95% CI。
* **灵敏度分析** ：
* πmin⁡∈{0.80,0.85,0.90,0.95}\pi_{\min}\in\{0.80,0.85,0.90,0.95\}**π**m**i**n∈**{**0.80**,**0.85**,**0.90**,**0.95**}**；
* 不同 c13,c28c_{13},c_{28}**c**13,**c**28；
* 质量阈值的松紧（或权重方案变化）；
* “只单次”对比“二阶段”的优劣曲线。
* **校准/可解释性** ：分组生存曲线对比、DCA/净获益曲线（可选）、决策边界可视化。

# 七、报告与结论表达（论文/答卷可直接使用）

1. **数据与样本** ：总体、各 BMI 组人数；质控与剔除率。
2. **模型与诊断** ：所选主模型（AFT/离散 hazard）、区间删失与质量协变量的处理、校准和验证图。
3. **分组结果** ：BMI 切点（含 95% CI；若用最优分箱，给出切点稳定性分析）。
4. **单次与两阶段推荐** ：

* 每组推荐的 tgt_g**t**g（单次）与 (t0g,t1g)(t_0^g,t_1^g)**(**t**0**g,**t**1**g****)**（两阶段）；
* 对应 FgF_g**F**g（达标比例）、预期时间/风险、复测率；
* 在“早/中/晚”三个区间的落点说明（避免≥28 周）。

1. **敏感性与局限** ：对参数与质量假设的稳健性、数据偏倚（高 BMI 样本占比）、外推限制。
2. **实现材料** ：代码、参数表、图表；（按竞赛规范）在附录放完整源代码，在支撑材料提供可运行脚本与数据字典；在文内标注 AI 工具使用处并在支撑材料给出使用详情清单。

# 八、实施清单（你们直接照此落地）

* **Step 0** ：固定随机种子，确定评估分折策略；
* **Step 1** ：清洗、统一字段、构造 [L,R][L,R]**[**L**,**R**]** 区间与质量协变量；
* **Step 2** ：拟合方案 A 或 B（含质量入模/权重），得到各 BMI 候选组的 Fg(t)F_g(t)**F**g(**t**)；
* **Step 3** ：做  **BMI 监督分割** （最优分箱/树），定组数与切点；
* **Step 4** （单次）：按 Fg(t)≥πmin⁡F_g(t)\ge \pi_{\min}**F**g(**t**)**≥**π**m**i**n** 与风险代价挑 tgt_g**t**g；
* **Step 5** （两阶段）：网格搜索 (t0g,t1g)(t_0^g,t_1^g)**(**t**0**g,**t**1**g****)** 以最小化 ET\mathrm{ET}**ET** 或 R\mathrm{R}**R**；
* **Step 6** ：Bootstrap 置信区间、灵敏度分析；
* **Step 7** ：产出表格/图（曲线 Fg(t)F_g(t)**F**g(**t**)、推荐时点、性能指标）；
